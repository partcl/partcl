RM_F    = @rm_f@
PERL    = @perl@
MAKE    = @make_c@

VERSION_DIR = @versiondir@
INCLUDE_DIR = @includedir@$(VERSION_DIR)
LIB_DIR = @libdir@$(VERSION_DIR)
BIN_DIR = @bindir@
PARROT  = $(BIN_DIR)/parrot@exe@
TOOLS_DIR = @libdir@$(VERSION_DIR)@slash@tools
RECONFIGURE = $(PERL) $(LIB_DIR)/tools/dev/gen_makefile.pl
PBC_TO_EXE    = $(BIN_DIR)/pbc_to_exe@exe@
#IF(darwin):
#IF(darwin):# MACOSX_DEPLOYMENT_TARGET must be defined for OS X compilation/linking
#IF(darwin):export MACOSX_DEPLOYMENT_TARGET := @osx_version@

TCL_LIB   = library
O         = @o@
PMCDIR    = src/pmc
OPSDIR    = src/ops
CLASSDIR  = src/class
LOAD_EXT  = @load_ext@
COPY      = @cp@
RENAME    = @mv@

CC_SHARED  = @cc_shared@
CFLAGS     = @ccflags@ @cc_debug@ @ccwarn@ @cc_hasjit@ @cg_flag@ @gc_flag@ $(CC_SHARED)
CC         = @cc@

TGE_DIR  = $(LIB_DIR)/languages/tge
PERL6GRAMMAR = $(LIB_DIR)/library/PGE/Perl6Grammar.pbc

RUNTIME_PIR = runtime/builtin/after.pir        runtime/builtin/linsert.pir \
runtime/builtin/append.pir       runtime/builtin/list.pir \
runtime/builtin/apply.pir        runtime/builtin/llength.pir \
runtime/builtin/array.pir        runtime/builtin/load.pir \
 runtime/builtin/lrange.pir \
 runtime/builtin/lrepeat.pir \
runtime/builtin/bgerror.pir      runtime/builtin/lreplace.pir \
runtime/builtin/binary.pir       runtime/builtin/lreverse.pir \
runtime/builtin/break.pir        runtime/builtin/lsearch.pir \
runtime/builtin/catch.pir        runtime/builtin/lset.pir \
runtime/builtin/cd.pir           runtime/builtin/lsort.pir \
runtime/builtin/chan.pir         runtime/builtin/memory.pir \
runtime/builtin/clock.pir        runtime/builtin/namespace.pir \
runtime/builtin/close.pir        runtime/builtin/open.pir \
runtime/builtin/concat.pir       runtime/builtin/package.pir \
runtime/builtin/continue.pir     \
runtime/builtin/dde.pir          runtime/builtin/pid.pir \
runtime/builtin/dict.pir         runtime/builtin/proc.pir \
runtime/builtin/encoding.pir     runtime/builtin/puts.pir \
runtime/builtin/eof.pir          runtime/builtin/pwd.pir \
runtime/builtin/error.pir        runtime/builtin/read.pir \
runtime/builtin/eval.pir         runtime/builtin/regexp.pir \
runtime/builtin/exec.pir         runtime/builtin/registry.pir \
runtime/builtin/exit.pir         runtime/builtin/regsub.pir \
runtime/builtin/expr.pir         runtime/builtin/rename.pir \
runtime/builtin/fblocked.pir     runtime/builtin/return.pir \
runtime/builtin/fconfigure.pir   runtime/builtin/scan.pir \
runtime/builtin/fcopy.pir        runtime/builtin/seek.pir \
runtime/builtin/file.pir         runtime/builtin/set.pir \
runtime/builtin/fileevent.pir    runtime/builtin/socket.pir \
runtime/builtin/flush.pir        runtime/builtin/source.pir \
runtime/builtin/for.pir          runtime/builtin/split.pir \
runtime/builtin/foreach.pir      runtime/builtin/string.pir \
runtime/builtin/format.pir       runtime/builtin/subst.pir \
runtime/builtin/gets.pir         runtime/builtin/switch.pir \
runtime/builtin/glob.pir         runtime/builtin/tell.pir \
runtime/builtin/global.pir       runtime/builtin/time.pir \
runtime/builtin/history.pir      runtime/builtin/trace.pir \
runtime/builtin/if.pir           \
runtime/builtin/incr.pir         runtime/builtin/unload.pir \
runtime/builtin/info.pir         runtime/builtin/unset.pir \
runtime/builtin/inline.pir       runtime/builtin/update.pir \
runtime/builtin/interp.pir       runtime/builtin/uplevel.pir \
runtime/builtin/join.pir         runtime/builtin/upvar.pir \
runtime/builtin/lappend.pir      runtime/builtin/variable.pir \
runtime/builtin/lassign.pir      runtime/builtin/vwait.pir \
runtime/builtin/lindex.pir       runtime/builtin/while.pir

DEPS = \
runtime/conversions.pir \
runtime/string_to_list.pir \
runtime/variables.pir \
runtime/options.pir \
src/macros.pir \
src/mathops.pir \
src/returncodes.pasm \
src/grammar/expr/expression.pir \
src/grammar/expr/functions.pir \
src/grammar/expr/parse.pir \
src/grammar/expr/operators.pir \
src/grammar/expr/past2pir.pir \
src/grammar/expr/pge2past.pir \
$(TCL_LIB)/parray.tcl \
$(RUNTIME_PIR)

# should be tclsh@exe@ but for TT #691
all: tcl.pbc

tcl.pbc: $(PARROT) pmcs ops runtime/tcllib.pbc src/tclsh.pir
	$(PARROT) --output=tcl.pbc src/tclsh.pir

.SUFFIXES : .pir .pg .tg

.tg.pir :
	$(PARROT) $(TGE_DIR)/tgc.pir --output=$@ $<

.pg.pir :
	$(PARROT) $(PERL6GRAMMAR) --output=$@ $<

.pir.pbc :
	$(PARROT) --output=$@ $<

CLASSES = \
  $(CLASSDIR)/tclarray.pir \
  $(CLASSDIR)/tclconst.pir \
  $(CLASSDIR)/tclproc.pir \
  $(CLASSDIR)/tracearray.pir

pmcs:
	$(MAKE) $(PMCDIR)

.c$(O) :
	$(CC) $(CFLAGS) -I$(INCLUDE_DIR) @cc_o_out@$@ -c $<

ops: src/binary$(O)
	$(MAKE) $(OPSDIR)

runtime/builtins.pir: $(DEPS) tools/gen_builtins.pl
	$(PERL) tools/gen_builtins.pl > runtime/builtins.pir

runtime/tcllib.pbc: $(PARROT) runtime/tcllib.pir runtime/builtins.pir $(CLASSES) ops
	$(PARROT) --output=runtime/tcllib.pbc runtime/tcllib.pir

# targets for building a standalone tclsh
# (We're not quite ready to make this a default target.)
tclsh@exe@: tcl.pbc $(PBC_TO_EXE)
	$(PBC_TO_EXE) tcl.pbc
	$(RENAME) tcl@exe@ tclsh@exe@

test: tcl.pbc
	$(PERL) -I$(TOOLS_DIR)/lib t/harness

spectest: tcl.pbc
	$(PERL) tools/tcl_test.pl

CLEANERS = \
tcl.c \
tcl$(O) \
tclsh@exe@ \
tcl.pbc \
runtime/builtins.pir \
"runtime/*.pbc" \
"$(CLASSDIR)/*.pbc" \
"$(PMCDIR)/pmc_*.h" \
"$(PMCDIR)/*_group.h" \
"$(PMCDIR)/*$(LOAD_EXT)" \
"$(PMCDIR)/*.dump" \
#IF(ld_parrot_exe_def):"$(PMCDIR)/*.def" \
"$(PMCDIR)/*.c" \
"$(PMCDIR)/*$(O)" \
"$(PMCDIR)/*.exp" \
"$(PMCDIR)/*.ilk" \
"$(PMCDIR)/*.lib" \
"$(PMCDIR)/*.pdb" \
"t/*.pir" \
"t/*.tcl" \
src/grammar/expr/expression.pir \
src/grammar/expr/past2pir.pir \
src/grammar/expr/pge2past.pir \
"$(OPSDIR)/*.c" \
"$(OPSDIR)/*.h" \
"src/*$(O)" \
"$(OPSDIR)/*$(O)" \
"$(OPSDIR)/*$(LOAD_EXT)" \
"$(OPSDIR)/*.bundle" \
"$(OPSDIR)/*.exp" \
"$(OPSDIR)/*.ilk" \
"$(OPSDIR)/*.lib" \
"$(OPSDIR)/*.pdb" \
"$(TCL_LIB)/*.pir" \
dynext/* \
lib/*.pre_c

# that last line should be cleaned up for x-platform.

clean:
	$(RM_F) $(CLEANERS)

realclean: clean
	$(RM_F) examples/Makefile Makefile t_tcl \
		$(PMCDIR)/Makefile $(OPSDIR)/Makefile \
		lib/Parrot/Installed.pm \
                t/internals/select_option.t \
                t/internals/select_switches.t

distclean: realclean

# regenerate the Makefiles
Makefile: config/makefiles/root.in config/makefiles/pmc.in config/makefiles/ops.in
	$(RECONFIGURE) config/makefiles/root.in Makefile
	$(RECONFIGURE) config/makefiles/pmc.in $(PMCDIR)/Makefile
	$(RECONFIGURE) config/makefiles/ops.in $(OPSDIR)/Makefile

