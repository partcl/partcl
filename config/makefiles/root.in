## shell commands
RM_F    = @rm_f@
PERL    = @perl@
MAKE    = @make_c@
RENAME  = @mv@

## external directories
VERSION_DIR = @versiondir@
INCLUDE_DIR = @includedir@$(VERSION_DIR)
LIB_DIR     = @libdir@$(VERSION_DIR)
BIN_DIR     = @bindir@
TOOLS_DIR   = @libdir@$(VERSION_DIR)/tools
TGE_DIR     = $(LIB_DIR)/languages/tge

## local directories
PMC_DIR     = src/pmc
OPS_DIR     = src/ops
CLASS_DIR   = src/class
BUILTIN_DIR = runtime/builtin
TCLLIB_DIR  = library

## parrot binaries & tools
PARROT       = $(BIN_DIR)/parrot@exe@
RECONFIGURE  = $(PERL) $(LIB_DIR)/tools/dev/gen_makefile.pl
PBC_TO_EXE   = $(BIN_DIR)/pbc_to_exe@exe@
PERL6GRAMMAR = $(LIB_DIR)/library/PGE/Perl6Grammar.pbc
#IF(darwin):
#IF(darwin):# MACOSX_DEPLOYMENT_TARGET must be defined for OS X compilation/linking
#IF(darwin):export MACOSX_DEPLOYMENT_TARGET := @osx_version@

## file extensions
O         = @o@
LOAD_EXT  = @load_ext@

## compiler
CC_SHARED  = @cc_shared@
CFLAGS     = @ccflags@ @cc_debug@ @ccwarn@ @cc_hasjit@ @cg_flag@ @gc_flag@ $(CC_SHARED)
CC         = @cc@

## partcl source 
BUILTINS_PIR = \
  $(BUILTIN_DIR)/after.pir      $(BUILTIN_DIR)/append.pir \
  $(BUILTIN_DIR)/apply.pir      $(BUILTIN_DIR)/array.pir \
  $(BUILTIN_DIR)/bgerror.pir    $(BUILTIN_DIR)/binary.pir \
  $(BUILTIN_DIR)/break.pir      $(BUILTIN_DIR)/catch.pir \
  $(BUILTIN_DIR)/cd.pir         $(BUILTIN_DIR)/chan.pir \
  $(BUILTIN_DIR)/clock.pir      $(BUILTIN_DIR)/close.pir \
  $(BUILTIN_DIR)/concat.pir     $(BUILTIN_DIR)/continue.pir \
  $(BUILTIN_DIR)/dde.pir        $(BUILTIN_DIR)/dict.pir \
  $(BUILTIN_DIR)/encoding.pir   $(BUILTIN_DIR)/eof.pir \
  $(BUILTIN_DIR)/error.pir      $(BUILTIN_DIR)/eval.pir \
  $(BUILTIN_DIR)/exec.pir       $(BUILTIN_DIR)/exit.pir \
  $(BUILTIN_DIR)/expr.pir       $(BUILTIN_DIR)/fblocked.pir \
  $(BUILTIN_DIR)/fconfigure.pir $(BUILTIN_DIR)/fcopy.pir \
  $(BUILTIN_DIR)/file.pir       $(BUILTIN_DIR)/fileevent.pir \
  $(BUILTIN_DIR)/flush.pir      $(BUILTIN_DIR)/for.pir \
  $(BUILTIN_DIR)/foreach.pir    $(BUILTIN_DIR)/format.pir \
  $(BUILTIN_DIR)/gets.pir       $(BUILTIN_DIR)/glob.pir \
  $(BUILTIN_DIR)/global.pir     $(BUILTIN_DIR)/if.pir \
  $(BUILTIN_DIR)/incr.pir       $(BUILTIN_DIR)/info.pir \
  $(BUILTIN_DIR)/inline.pir     $(BUILTIN_DIR)/interp.pir \
  $(BUILTIN_DIR)/join.pir       $(BUILTIN_DIR)/lappend.pir \
  $(BUILTIN_DIR)/lassign.pir    $(BUILTIN_DIR)/lindex.pir \
  $(BUILTIN_DIR)/linsert.pir    $(BUILTIN_DIR)/list.pir \
  $(BUILTIN_DIR)/llength.pir    $(BUILTIN_DIR)/load.pir \
  $(BUILTIN_DIR)/lrange.pir     $(BUILTIN_DIR)/lrepeat.pir \
  $(BUILTIN_DIR)/lreplace.pir   $(BUILTIN_DIR)/lreverse.pir \
  $(BUILTIN_DIR)/lsearch.pir    $(BUILTIN_DIR)/lset.pir \
  $(BUILTIN_DIR)/lsort.pir      $(BUILTIN_DIR)/memory.pir \
  $(BUILTIN_DIR)/namespace.pir  $(BUILTIN_DIR)/open.pir \
  $(BUILTIN_DIR)/package.pir    $(BUILTIN_DIR)/pid.pir \
  $(BUILTIN_DIR)/proc.pir       $(BUILTIN_DIR)/puts.pir \
  $(BUILTIN_DIR)/pwd.pir        $(BUILTIN_DIR)/read.pir \
  $(BUILTIN_DIR)/regexp.pir     $(BUILTIN_DIR)/registry.pir \
  $(BUILTIN_DIR)/regsub.pir     $(BUILTIN_DIR)/rename.pir \
  $(BUILTIN_DIR)/return.pir     $(BUILTIN_DIR)/scan.pir \
  $(BUILTIN_DIR)/seek.pir       $(BUILTIN_DIR)/set.pir \
  $(BUILTIN_DIR)/socket.pir     $(BUILTIN_DIR)/source.pir \
  $(BUILTIN_DIR)/split.pir      $(BUILTIN_DIR)/string.pir \
  $(BUILTIN_DIR)/subst.pir      $(BUILTIN_DIR)/switch.pir \
  $(BUILTIN_DIR)/tell.pir       $(BUILTIN_DIR)/time.pir \
  $(BUILTIN_DIR)/trace.pir      $(BUILTIN_DIR)/unload.pir \
  $(BUILTIN_DIR)/unset.pir      $(BUILTIN_DIR)/update.pir \
  $(BUILTIN_DIR)/uplevel.pir    $(BUILTIN_DIR)/upvar.pir \
  $(BUILTIN_DIR)/variable.pir   $(BUILTIN_DIR)/vwait.pir \
  $(BUILTIN_DIR)/while.pir

CLASSES = \
  $(CLASS_DIR)/string.pir \
  $(CLASS_DIR)/tclarray.pir \
  $(CLASS_DIR)/tclconst.pir \
  $(CLASS_DIR)/tcldict.pir \
  $(CLASS_DIR)/tclint.pir \
  $(CLASS_DIR)/tcllist.pir \
  $(CLASS_DIR)/tclproc.pir \
  $(CLASS_DIR)/tclstring.pir \
  $(CLASS_DIR)/tracearray.pir

SRC_DEPS = \
  runtime/builtins.pir \
  runtime/compilers.pir \
  runtime/conversions.pir \
  runtime/variables.pir \
  runtime/options.pir \
  src/macros.pir \
  src/mathops.pir \
  src/returncodes.pasm \
  src/grammar/expr/expression.pir \
  src/grammar/expr/functions.pir \
  src/grammar/expr/parse.pir \
  src/grammar/expr/operators.pir \
  src/grammar/expr/past2pir.pir \
  src/grammar/expr/pge2past.pir \
  $(TCLLIB_DIR)/parray.tcl \
  $(CLASSES)

## build
all: tclsh@exe@

tclsh@exe@: tcl.pbc $(PBC_TO_EXE)
	$(PBC_TO_EXE) tcl.pbc
	$(RENAME) tcl@exe@ tclsh@exe@

tcl.pbc: $(PARROT) pmcs ops runtime/tcllib.pbc src/tclsh.pir
	$(PARROT) --output=tcl.pbc src/tclsh.pir

runtime/builtins.pir: $(BUILTINS_PIR) tools/gen_builtins.pl
	$(PERL) tools/gen_builtins.pl > runtime/builtins.pir

runtime/tcllib.pbc: $(PARROT) runtime/tcllib.pir pmcs ops $(SRC_DEPS)
	$(PARROT) --output=runtime/tcllib.pbc runtime/tcllib.pir

## subdirs
pmcs:
	$(MAKE) $(PMC_DIR)

ops: src/binary$(O)
	$(MAKE) $(OPS_DIR)

## suffix rules
.SUFFIXES : .pir .pg .tg

.tg.pir :
	$(PARROT) $(TGE_DIR)/tgc.pir --output=$@ $<

.pg.pir :
	$(PARROT) $(PERL6GRAMMAR) --output=$@ $<

.pir.pbc :
	$(PARROT) --output=$@ $<

.c$(O) :
	$(CC) $(CFLAGS) -I$(INCLUDE_DIR) @cc_o_out@$@ -c $<

## Testing
test: tcl.pbc
	$(PERL) -I$(TOOLS_DIR)/lib t/harness

partcl_test_run.tar.gz: tcl.pbc
	- $(PERL) -I$(TOOLS_DIR)/lib t/harness --archive partcl_test_run.tar.gz --parrot_revision @revision@

smolder: partcl_test_run.tar.gz
	curl -F architecture=@cpuarch@ -F platform=@osname@ -F revision=@partcl_revision@ -F report_file=@partcl_test_run.tar.gz http:////smolder.plusthree.com//app//public_projects//process_add_report//17

spectest: tcl.pbc
	$(PERL) tools/tcl_test.pl

specinfo: tcl.pbc
	$(PERL) tools/spec_info.pl

unfudge: tcl.pbc
	$(PERL) tools/tcl_test.pl --skip

## cleanup

CLEANERS = \
tcl.c \
tcl$(O) \
tclsh@exe@ \
tcl.pbc \
runtime/builtins.pir \
"runtime/*.pbc" \
"$(CLASSDIR)/*.pbc" \
"$(PMC_DIR)/pmc_*.h" \
"$(PMC_DIR)/*_group.h" \
"$(PMC_DIR)/*$(LOAD_EXT)" \
"$(PMC_DIR)/*.dump" \
#IF(ld_parrot_exe_def):"$(PMC_DIR)/*.def" \
"$(PMC_DIR)/*.c" \
"$(PMC_DIR)/*$(O)" \
"$(PMC_DIR)/*.exp" \
"$(PMC_DIR)/*.ilk" \
"$(PMC_DIR)/*.lib" \
"$(PMC_DIR)/*.pdb" \
"t/*.pir" \
"t/*.tcl" \
src/grammar/expr/expression.pir \
src/grammar/expr/past2pir.pir \
src/grammar/expr/pge2past.pir \
"$(OPS_DIR)/*.c" \
"$(OPS_DIR)/*.h" \
"src/*$(O)" \
"$(OPS_DIR)/*$(O)" \
"$(OPS_DIR)/*$(LOAD_EXT)" \
"$(OPS_DIR)/*.bundle" \
"$(OPS_DIR)/*.exp" \
"$(OPS_DIR)/*.ilk" \
"$(OPS_DIR)/*.lib" \
"$(OPS_DIR)/*.pdb" \
"$(TCLLIB_DIR)/*.pir" \
dynext/* \
lib/*.pre_c

# that last line should be cleaned up for x-platform.

clean:
	$(RM_F) $(CLEANERS)

realclean: clean
	$(RM_F) Makefile t_tcl tcl-cvs \
		$(PMC_DIR)/Makefile $(OPS_DIR)/Makefile \
		lib/Parrot/Installed.pm \
                t/internals/select_option.t \
                t/internals/select_switches.t

distclean: realclean

## regenerate makefiles
Makefile: config/makefiles/root.in
	$(RECONFIGURE) config/makefiles/root.in Makefile
src/pmc/Makefile: config/makefiles/pmc.in
	$(RECONFIGURE) config/makefiles/pmc.in $(PMC_DIR)/Makefile
src/ops/Makefile: config/makefiles/ops.in
	$(RECONFIGURE) config/makefiles/ops.in $(OPS_DIR)/Makefile

## copy tcl cvs repository
tcl-cvs:
	$(PERL) tools/tcl_cvs.pl tcl-cvs
